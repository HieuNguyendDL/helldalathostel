<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Hello Dalat Hostel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        .sidebar-link.active { background-color: #4f46e5; color: white; }
        .modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 40; }
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 50; max-height: 90vh; overflow-y: auto; }
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="flex h-screen bg-gray-100">
        <!-- Sidebar -->
        <div class="hidden md:flex flex-col w-64 bg-white shadow-lg">
            <div class="flex items-center justify-center h-20 shadow-md"><h1 class="text-2xl font-bold text-indigo-600">Hello Dalat</h1></div>
            <ul class="flex flex-col py-4">
                <li><a href="#" data-view="dashboard" class="sidebar-link flex items-center h-12 px-6 text-gray-600 active"><span>Bảng điều khiển</span></a></li>
                <li><a href="#" data-view="calendar" class="sidebar-link flex items-center h-12 px-6 text-gray-600"><span>Lịch phòng trống</span></a></li>
                <li><a href="#" data-view="bookings" class="sidebar-link flex items-center h-12 px-6 text-gray-600"><span>Quản lý Booking</span></a></li>
                <li><a href="#" data-view="finance" class="sidebar-link flex items-center h-12 px-6 text-gray-600"><span>Tài chính & Thu Chi</span></a></li>
            </ul>
        </div>

        <!-- Main content -->
        <div class="flex flex-col flex-1 overflow-y-auto">
            <header class="flex items-center justify-between h-20 px-6 bg-white border-b shadow-md sticky top-0 z-20">
                <h2 id="view-title" class="text-xl font-semibold text-gray-700">Bảng điều khiển</h2>
                <button class="px-4 py-2 font-semibold text-white bg-indigo-600 rounded-lg" onclick="openAddBookingModal()">+ Thêm Booking mới</button>
            </header>
            <main class="p-6">
                <div id="dashboard-view" class="view-content"></div>
                <div id="calendar-view" class="view-content hidden"></div>
                <div id="bookings-view" class="view-content hidden"></div>
                <div id="finance-view" class="view-content hidden"></div>
            </main>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="modal-backdrop" class="modal-backdrop" onclick="closeAllModals()"></div>
    <div id="add-booking-modal" class="modal bg-white rounded-lg shadow-xl w-11/12 md:w-2/3 lg:w-1/2"></div>
    <div id="booking-detail-modal" class="modal bg-white rounded-lg shadow-xl w-11/12 md:w-3/4 lg:w-2/3"></div>

    <script>
        const API_BASE_URL = 'https://hellodalat.onrender.com';
        let AppState = { bookings: [], rooms: {}, services: [], info: {}, financial_transactions: [] };

        async function fetchAPI(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({error: `HTTP error! status: ${response.status}`}));
                    throw new Error(errorData.error);
                }
                if (options.responseType === 'blob') return await response.blob();
                return await response.json();
            } catch (error) {
                console.error(`Lỗi API ${endpoint}:`, error);
                alert(`Lỗi kết nối máy chủ: ${error.message}`);
                return null;
            }
        }
        
        // --- Navigation ---
        document.querySelectorAll('.sidebar-link').forEach(link => {
            link.addEventListener('click', e => {
                e.preventDefault();
                document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                const viewId = link.dataset.view;
                document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden'));
                document.getElementById(`${viewId}-view`).classList.remove('hidden');
                document.getElementById('view-title').textContent = link.querySelector('span').textContent;
            });
        });

        // --- Modal Logic ---
        function openModal(modalId) { document.getElementById(modalId).style.display = 'block'; document.getElementById('modal-backdrop').style.display = 'block'; }
        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; document.getElementById('modal-backdrop').style.display = 'none'; }
        function closeAllModals() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); document.getElementById('modal-backdrop').style.display = 'none'; }

        // --- RENDER FUNCTIONS ---
        function renderAll() {
            renderBookingsTable();
            // Call other render functions here
        }

        function renderBookingsTable(filteredData = null) {
            const view = document.getElementById('bookings-view');
            view.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-md"><input type="text" id="booking-search" placeholder="Tìm kiếm theo tên, mã booking..." class="w-full px-4 py-2 border rounded-lg mb-4"><div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="bg-gray-100"><th class="p-3">Mã</th><th class="p-3">Khách</th><th class="p-3">Check-in</th><th class="p-3">Check-out</th><th class="p-3">Trạng thái</th><th class="p-3"></th></tr></thead><tbody id="bookings-table-body"></tbody></table></div></div>`;
            const tbody = document.getElementById('bookings-table-body');
            tbody.innerHTML = '';
            (filteredData || AppState.bookings).forEach(b => {
                let statusClass = {'da_nhan_phong': 'bg-blue-100 text-blue-800', 'da_dat': 'bg-yellow-100 text-yellow-800', 'da_tra_phong': 'bg-green-100 text-green-800', 'da_huy': 'bg-gray-100 text-gray-800'}[b.trang_thai] || '';
                tbody.innerHTML += `<tr>
                    <td class="p-3 font-semibold">${b.booking_id}</td><td>${b.ten_khach || b.ten_truong_doan}</td>
                    <td>${b.check_in_date}</td><td>${b.check_out_date}</td>
                    <td><span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">${b.trang_thai.replace('_', ' ')}</span></td>
                    <td><button class="text-indigo-600 text-sm font-semibold" onclick="openBookingDetailModal('${b.booking_id}')">Chi tiết</button></td></tr>`;
            });
            document.getElementById('booking-search').addEventListener('input', e => {
                const query = e.target.value.toLowerCase();
                renderBookingsTable(AppState.bookings.filter(b => JSON.stringify(b).toLowerCase().includes(query)));
            });
        }

        async function openBookingDetailModal(bookingId) {
            const booking = AppState.bookings.find(b => b.booking_id === bookingId);
            if (!booking) { alert('Không tìm thấy booking!'); return; }
            const modal = document.getElementById('booking-detail-modal');
            
            // Basic calculations
            const nights = (new Date(booking.check_out_date) - new Date(booking.check_in_date)) / (1000 * 3600 * 24) || 1;
            const roomCost = booking.phong_dat.reduce((acc, p) => acc + (p.gia_thoa_thuan * nights), 0);
            const serviceCost = booking.dich_vu_da_dung.reduce((acc, s) => acc + (s.gia * s.so_luong), 0);
            const totalPaid = booking.thanh_toan.reduce((acc, p) => acc + p.so_tien, 0);
            const totalBill = roomCost + serviceCost;

            modal.innerHTML = `
                <div class="p-6 border-b flex justify-between items-center">
                    <h3 class="text-xl font-semibold">Chi tiết Booking #${booking.booking_id}</h3><button onclick="closeModal('booking-detail-modal')">&times;</button>
                </div>
                <div class="p-6 grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-2 space-y-4">
                        <div><h4 class="font-semibold">Thông tin khách</h4><p>${booking.ten_khach || booking.ten_truong_doan}</p></div>
                        <div><h4 class="font-semibold">Phòng đã đặt</h4>${booking.phong_dat.map(p => `<p>${p.so_phong} (${p.loai_phong})</p>`).join('')}</div>
                    </div>
                    <div class="space-y-4">
                        <h4 class="font-semibold">Tài chính</h4>
                        <p>Tiền phòng: ${roomCost.toLocaleString()} VNĐ</p>
                        <p>Tiền dịch vụ: ${serviceCost.toLocaleString()} VNĐ</p>
                        <p class="font-bold">Tổng cộng: ${totalBill.toLocaleString()} VNĐ</p>
                        <p class="text-green-600">Đã thanh toán: ${totalPaid.toLocaleString()} VNĐ</p>
                        <p class="font-bold text-red-600">Còn lại: ${(totalBill - totalPaid).toLocaleString()} VNĐ</p>
                    </div>
                </div>
                <div class="p-4 bg-gray-50 flex justify-end space-x-2">
                    <button class="px-4 py-2 bg-red-600 text-white rounded-lg text-sm" onclick="confirmDeleteBooking('${booking.booking_id}')">Xóa Booking</button>
                    <button class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm" onclick="downloadInvoice('${booking.booking_id}')">In hóa đơn</button>
                </div>
            `;
            openModal('booking-detail-modal');
        }

        async function confirmDeleteBooking(bookingId) {
            if (confirm(`Bạn có chắc chắn muốn xóa booking ${bookingId}?`)) {
                const result = await fetchAPI(`/api/bookings/${bookingId}`, { method: 'DELETE' });
                if (result) {
                    alert(result.message);
                    closeAllModals();
                    initializeApp();
                }
            }
        }
        
        async function downloadInvoice(bookingId) {
            const blob = await fetchAPI(`/api/bookings/${bookingId}/invoice-pdf`, { responseType: 'blob' });
            if (blob) {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `Invoice_${bookingId}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            }
        }
        
        // --- BOOKING FORM LOGIC (Hàm đã có từ trước, giữ nguyên) ---
        function openAddBookingModal() { /*...*/ }
        async function checkAvailableRooms() { /*...*/ }
        function selectRoom(roomId, price) { /*...*/ }
        async function handleBookingFormSubmit(event) { /*...*/ }

        // --- INITIALIZATION ---
        async function initializeApp() {
            const data = await fetchAPI('/api/data');
            if (data) { AppState = data; renderAll(); }
        }
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
