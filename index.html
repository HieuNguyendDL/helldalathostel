<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Hello Dalat Hostel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        .sidebar-link.active { background-color: #4f46e5; color: white; }
        .sidebar-link:not(.active):hover { background-color: #eef2ff; }
        .modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 40; }
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 50; max-height: 90vh; overflow-y: auto; }
        .tab-button.active { border-color: #4f46e5; color: #4f46e5; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="flex h-screen bg-gray-100">
        <!-- Sidebar -->
        <div id="sidebar" class="hidden md:flex flex-col w-64 bg-white shadow-lg">
            <div class="flex items-center justify-center h-20 shadow-md"><h1 class="text-2xl font-bold text-indigo-600">Hello Dalat</h1></div>
            <ul class="flex flex-col py-4">
                <li><a href="#" data-action="navigate" data-view="dashboard" class="sidebar-link flex items-center h-12 px-6 text-gray-600 active"><span class="pointer-events-none">Bảng điều khiển</span></a></li>
                <li><a href="#" data-action="navigate" data-view="calendar" class="sidebar-link flex items-center h-12 px-6 text-gray-600"><span class="pointer-events-none">Lịch phòng trống</span></a></li>
                <li><a href="#" data-action="navigate" data-view="bookings" class="sidebar-link flex items-center h-12 px-6 text-gray-600"><span class="pointer-events-none">Quản lý Booking</span></a></li>
                <li><a href="#" data-action="navigate" data-view="finance" class="sidebar-link flex items-center h-12 px-6 text-gray-600"><span class="pointer-events-none">Tài chính</span></a></li>
            </ul>
        </div>

        <!-- Main content -->
        <div class="flex flex-col flex-1 overflow-y-auto">
            <header class="flex items-center justify-between h-20 px-6 bg-white border-b shadow-md sticky top-0 z-20">
                <h2 id="view-title" class="text-xl font-semibold text-gray-700">Bảng điều khiển</h2>
                <button data-action="open-add-booking-modal" class="px-4 py-2 font-semibold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700">
                    + Thêm Booking mới
                </button>
            </header>
            <main id="main-content" class="p-6">
                <!-- Views will be injected here by JavaScript -->
            </main>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="modal-backdrop" class="modal-backdrop"></div>
    <div id="main-modal" class="modal bg-white rounded-lg shadow-xl w-11/12 md:w-2/3 lg:w-1/2"></div>
    <div id="detail-modal" class="modal bg-white rounded-lg shadow-xl w-11/12 md:w-3/4 lg:w-2/3"></div>

    <script>
        const API_BASE_URL = 'https://hellodalat.onrender.com';
        let AppState = { bookings: [], rooms: {}, services: [], info: {}, financial_transactions: [] };

        async function fetchAPI(endpoint, options = {}) {
            try {
                const url = `${API_BASE_URL}/api${endpoint}`;
                const response = await fetch(url, options);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({error: `HTTP error! status: ${response.status}`}));
                    throw new Error(`Lỗi ${response.status}: ${errorData.error || 'Endpoint không tồn tại hoặc có lỗi ở server.'}`);
                }
                if (options.responseType === 'blob') return await response.blob();
                const textData = await response.text();
                return textData ? JSON.parse(textData) : {};
            } catch (error) {
                console.error(`Lỗi API tại endpoint '${endpoint}':`, error);
                alert(`Lỗi kết nối máy chủ:\nEndpoint: ${endpoint}\nLỗi: ${error.message}`);
                return null;
            }
        }
        
        const openModal = (modalId, content) => {
            const modal = document.getElementById(modalId);
            modal.innerHTML = content;
            modal.style.display = 'block';
            document.getElementById('modal-backdrop').style.display = 'block';
        };

        const closeModal = (modalId) => {
            const modal = document.getElementById(modalId);
            modal.style.display = 'none';
            document.getElementById('modal-backdrop').style.display = 'none';
        };

        const closeAllModals = () => {
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
            document.getElementById('modal-backdrop').style.display = 'none';
        };

        const renderView = (viewId) => {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = '<div>Đang tải...</div>';
            let content = '';
            switch(viewId) {
                case 'dashboard': content = renderDashboard(); break;
                case 'bookings': content = renderBookingsTable(); break;
                case 'calendar': content = renderCalendar(); break;
                case 'finance': content = renderFinance(); break;
                default: content = renderDashboard();
            }
            mainContent.innerHTML = content;
        };

        const renderBookingsTable = (filteredData = null) => {
            let tableHtml = `<div class="bg-white p-6 rounded-lg shadow-md"><input type="text" id="booking-search" placeholder="Tìm kiếm theo tên, mã booking..." class="w-full px-4 py-2 border rounded-lg mb-4"><div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="bg-gray-100"><th class="p-3">Mã</th><th class="p-3">Khách</th><th class="p-3">Check-in</th><th class="p-3">Check-out</th><th class="p-3">Trạng thái</th><th class="p-3"></th></tr></thead><tbody id="bookings-table-body">`;
            const dataToRender = (filteredData || AppState.bookings).sort((a,b) => b.booking_id.localeCompare(a.booking_id, undefined, {numeric: true}));
            dataToRender.forEach(b => {
                let statusClass = {'da_nhan_phong': 'bg-blue-100 text-blue-800', 'da_dat': 'bg-yellow-100 text-yellow-800', 'da_tra_phong': 'bg-green-100 text-green-800', 'da_huy': 'bg-gray-100 text-gray-800'}[b.trang_thai] || '';
                tableHtml += `<tr>
                    <td class="p-3 font-semibold">${b.booking_id}</td><td>${b.ten_khach || b.ten_truong_doan}</td>
                    <td>${b.check_in_date}</td><td>${b.check_out_date}</td>
                    <td><span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">${b.trang_thai.replace(/_/g, ' ')}</span></td>
                    <td><button data-action="open-booking-detail" data-id="${b.booking_id}" class="text-indigo-600 text-sm font-semibold">Chi tiết</button></td></tr>`;
            });
            tableHtml += `</tbody></table></div></div>`;
            return tableHtml;
        };
        
        const renderDashboard = () => `<p>Trang Dashboard đang được xây dựng.</p>`;
        const renderCalendar = () => `<p>Trang Lịch đang được xây dựng.</p>`;
        const renderFinance = () => `<p>Trang Tài chính đang được xây dựng.</p>`;

        const openAddBookingModal = () => {
            const content = `
                <div class="p-6 border-b flex justify-between items-center"><h3 class="text-xl font-semibold">Thêm Booking mới</h3><button data-action="close-modal" data-modal-id="main-modal">&times;</button></div>
                <form data-action="save-booking">
                    <div class="p-6 space-y-4">
                        <input type="hidden" id="booking-id">
                        <div><label>Loại khách</label><select id="guest-type" class="w-full mt-1 p-2 border rounded"><option value="le">Khách lẻ</option><option value="doan">Khách đoàn</option></select></div>
                        <div><label>Tên khách / Trưởng đoàn</label><input type="text" id="guest-name" required class="w-full mt-1 p-2 border rounded"></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label>Ngày đến</label><input type="date" id="checkin-date" required class="w-full mt-1 p-2 border rounded"></div>
                            <div><label>Ngày đi</label><input type="date" id="checkout-date" required class="w-full mt-1 p-2 border rounded"></div>
                        </div>
                        <button type="button" data-action="check-available-rooms" class="w-full p-2 bg-gray-600 text-white rounded">Kiểm tra phòng trống</button>
                        <div id="available-rooms-container" class="hidden"><label>Phòng trống</label><div id="available-rooms-list" class="grid grid-cols-4 gap-2 mt-1"></div></div>
                        <div><label>Phòng đã chọn</label><div id="selected-rooms-list" class="space-y-2 mt-1"></div></div>
                    </div>
                    <div class="p-4 bg-gray-50 flex justify-end"><button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded">Lưu Booking</button></div>
                </form>
            `;
            openModal('main-modal', content);
        };
        
        const checkAvailableRooms = async () => {
            const checkin = document.getElementById('checkin-date').value;
            const checkout = document.getElementById('checkout-date').value;
            if (!checkin || !checkout) { alert('Vui lòng chọn ngày.'); return; }
            const data = await fetchAPI(`/available-rooms?checkin=${checkin}&checkout=${checkout}`);
            if (!data) return;
            const listContainer = document.getElementById('available-rooms-list');
            listContainer.innerHTML = '';
            if (data.available_rooms.length === 0) { listContainer.innerHTML = '<p class="col-span-full text-center text-gray-500">Hết phòng.</p>'; } 
            else {
                data.available_rooms.forEach(roomId => {
                    listContainer.innerHTML += `<button type="button" data-action="select-room" data-id="${roomId}" data-price="${data.all_rooms_info[roomId].gia_goc}" class="p-2 border rounded hover:bg-indigo-100">${roomId}</button>`;
                });
            }
            document.getElementById('available-rooms-container').classList.remove('hidden');
        };

        const selectRoom = (roomId, price) => {
            if (document.getElementById(`selected-${roomId}`)) return;
            document.getElementById('selected-rooms-list').innerHTML += `<div id="selected-${roomId}" class="selected-room-item flex justify-between items-center p-2 bg-gray-100 rounded"><span>Phòng ${roomId}</span><input type="number" value="${price}" class="w-32 text-right p-1 border rounded"><button type="button" data-action="remove-room" class="px-2 font-bold text-red-500">&times;</button></div>`;
        };
        
        const handleBookingFormSubmit = async (event) => {
            const form = event.target;
            const bookingData = {
                guest_type: form.querySelector('#guest-type').value,
                guest_name: form.querySelector('#guest-name').value,
                checkin_date: form.querySelector('#checkin-date').value,
                checkout_date: form.querySelector('#checkout-date').value,
                rooms: Array.from(form.querySelectorAll('.selected-room-item')).map(el => ({
                    room_id: el.id.replace('selected-', ''),
                    price: parseInt(el.querySelector('input').value)
                }))
            };
            if (bookingData.rooms.length === 0) { alert('Vui lòng chọn ít nhất một phòng.'); return; }
            const result = await fetchAPI('/bookings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(bookingData) });
            if (result) {
                alert(`Đã tạo booking: ${result.booking_id}`);
                closeAllModals();
                initializeApp();
            }
        };
        
        const openBookingDetailModal = (bookingId) => {
            const booking = AppState.bookings.find(b => b.booking_id === bookingId);
            if (!booking) { alert('Không tìm thấy booking!'); return; }
            const nights = (new Date(booking.check_out_date) - new Date(booking.check_in_date)) / 86400000 || 1;
            const roomCost = booking.phong_dat.reduce((a, p) => a + (p.gia_thoa_thuan * nights), 0);
            const serviceCost = booking.dich_vu_da_dung.reduce((a, s) => a + (s.gia * s.so_luong), 0);
            const totalPaid = booking.thanh_toan.reduce((a, p) => a + p.so_tien, 0);
            const totalBill = roomCost + serviceCost;

            const content = `
                <div class="p-6 border-b flex justify-between items-center"><h3 class="text-xl font-semibold">Chi tiết Booking #${bookingId}</h3><button data-action="close-modal" data-modal-id="detail-modal">&times;</button></div>
                <div class="p-6 grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-2 space-y-4">
                        <div><h4 class="font-semibold">Thông tin khách</h4><p>${booking.ten_khach || booking.ten_truong_doan}</p></div>
                        <div><h4 class="font-semibold">Phòng đã đặt</h4>${booking.phong_dat.map(p => `<p>${p.so_phong} (${p.loai_phong})</p>`).join('')}</div>
                    </div>
                    <div class="space-y-2">
                        <h4 class="font-semibold">Tài chính</h4>
                        <p>Tiền phòng: ${roomCost.toLocaleString()} VNĐ</p>
                        <p>Tiền dịch vụ: ${serviceCost.toLocaleString()} VNĐ</p>
                        <p class="font-bold">Tổng cộng: ${totalBill.toLocaleString()} VNĐ</p>
                        <p class="text-green-600">Đã thanh toán: ${totalPaid.toLocaleString()} VNĐ</p>
                        <p class="font-bold text-red-600">Còn lại: ${(totalBill - totalPaid).toLocaleString()} VNĐ</p>
                    </div>
                </div>
                <div class="p-4 bg-gray-50 flex justify-end space-x-2">
                    <button data-action="delete-booking" data-id="${bookingId}" class="px-4 py-2 bg-red-600 text-white rounded-lg text-sm">Xóa Booking</button>
                    <button data-action="download-invoice" data-id="${bookingId}" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm">In hóa đơn</button>
                </div>`;
            openModal('detail-modal', content);
        };

        const confirmDeleteBooking = async (bookingId) => {
            if (confirm(`Bạn có chắc chắn muốn xóa booking ${bookingId}?`)) {
                const result = await fetchAPI(`/bookings/${bookingId}`, { method: 'DELETE' });
                if (result) {
                    alert(result.message);
                    closeAllModals();
                    initializeApp();
                }
            }
        };
        
        const downloadInvoice = async (bookingId) => {
            const blob = await fetchAPI(`/bookings/${bookingId}/invoice-pdf`, { responseType: 'blob' });
            if (blob) {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none'; a.href = url; a.download = `Invoice_${bookingId}.pdf`;
                document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(url);
            }
        };

        // --- INITIALIZATION ---
        const initializeApp = async () => {
            console.log("Đang khởi tạo ứng dụng và tải dữ liệu...");
            const data = await fetchAPI('/data');
            if (data) { 
                AppState = data;
                renderView('bookings');
            } else {
                document.getElementById('main-content').innerHTML = `<p class="text-red-500">Lỗi nghiêm trọng: Không thể tải dữ liệu từ server.</p>`;
            }
        };
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
